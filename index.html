<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!-- You might want to try something fancier: -->
<!-- html/nunjucks docs: https://mozilla.github.io/nunjucks/ -->
<!-- pug: https://pugjs.org/ -->
<!-- haml: http://haml.info/ -->
<!DOCTYPE html>
<html>
  <head>
    <title>ProntoChat</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"/>
    <style>
      #messageForm{
        width: 100%;
        position: fixed;
        bottom: 2.5%;

        /* And if you want the div to be full-width: */
        left: 0;
        right: 0;
      }
      #messageBox{
        width: 100%;
      }
      #messageBoxFormGroup{
        width:80%;
        margin: 0 auto;
        display: block;
      }
      #sendButton{

   
        
      }
      #messages{
        /*width: 100%;*/
        position: absolute;
        top: 0%;
        margin: 0;
        /* And if you want the div to be full-width: */
        left: 0;
        right: 0;
        width:100%;
        height:90%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  </head>
  <body>
    <ul class="list-group" id="messages">
      <li class="list-group-item" id="receivedMessage1"></li>
    </ul>
    <form class="form-inline" id="messageForm">
      <div class="form-group mx-sm-3" id="messageBoxFormGroup">
        <input type="text" class="form-control" id="messageBox" placeholder="Message">
      </div>
      <button class="btn btn-primary" id="sendButton" type="button">Send</button>
    </form>
  </body>
  <script>
    function getRoomId() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars.roomId;
    }
    function getUsername() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars.username;
    }
    var roomId = getRoomId()
    var username = getUsername()
    if(username == null) {
      window.location.replace(
        "http://prontochat.glitch.me/join?roomId=" + roomId);
    }
    console.log(roomId)
    function createSocket() {
      var exampleSocket = new WebSocket("wss://prontochat.glitch.me");
      exampleSocket.onclose = function(event) {
        console.log("Closed!");
        createSocket();
      };
      exampleSocket.onopen = function(event) {
        console.log("Opened!");
        function sendMessage(message) {
          exampleSocket.send("message|" + message + "|" + roomId)
        }
        function displayMessage(message) {
          var cloneMessage = document.getElementById("receivedMessage1").cloneNode(true)
          cloneMessage.innerText = message
          var messages = document.getElementById("messages")
          var numberOfMessages = messages.childElementCount
          cloneMessage.id = "receivedMessage" + numberOfMessages + 1
          messages.appendChild(cloneMessage)
          messages.scrollTop = messages.scrollHeight
        }
        document.getElementById('messageForm').addEventListener('submit', function(e) {
          var messageBoxText = document.getElementById("messageBox").value
          if(messageBoxText != "") {
            document.getElementById("messageBox").value = ""
            console.log("Sent message " + messageBoxText)
            sendMessage(username + ": " + messageBoxText)
          }
          e.preventDefault();
        }, false);
        document.getElementById("sendButton").onclick = function(){
          var messageBoxText = document.getElementById("messageBox").value
          if(messageBoxText != "") {
            document.getElementById("messageBox").value = ""
            console.log("Sent message " + messageBoxText)
            sendMessage(username + ": " + messageBoxText)
          }
          e.preventDefault();
        }
        for (i = 0; i < 50; i++) {
          displayMessage(" ")
        }
        $.get( "http://prontochat.glitch.me/getRoomMessages?roomId=" + roomId, function( data ) {
          var previousMessages = data.split("\n")
          previousMessages.forEach(message => {
            displayMessage(message)
          });
        });
        exampleSocket.onmessage = function(event) {
          var messageData = event.data
          var splitMessageData = messageData.split("|")
          if(splitMessageData[0] == "received") {
            var destinationRoom = splitMessageData[2]
            if(destinationRoom == roomId) {
              console.log(destinationRoom)
              var messageContent = splitMessageData[1]
              var userWhoSent = splitMessageData[3]
              console.log(messageContent)
              displayMessage(messageContent)
            }
          }
        };
      };
    }
    createSocket();
  </script>
</html>
